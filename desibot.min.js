(function loadDesiBotCSS() {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://yourcdn.com/desibot.min.css"; // âœ… replace with your actual CDN CSS URL
    document.head.appendChild(link);
  })();

window.initDesiBot = function ({
  userId,
  theme = "light",
  title = "DesiBot",
  position = "bottom-right",
  backendUrl = "http://localhost:8080"
}) {
  // Chat Icon (Always visible)
  const launcher = document.createElement("div");
  launcher.id = "desibot-launcher";
  launcher.className = `desibot-launcher ${position}`;
  launcher.innerHTML = "ðŸ’¬";
  document.body.appendChild(launcher);

  let container;
  let isFirstTime = true; // Track if it's the first time opening the chat

  launcher.onclick = function () {
    if (!container) {
      // Create the container and add the chat UI
      container = document.createElement("div");
      container.id = "desibot-container";
      container.className = `desibot-${theme} ${position}`;

      container.innerHTML = `
        <div id="desibot-header">
          <span>${title}</span>
          <span id="desibot-close">Ã—</span>
        </div>
        <div id="desibot-messages"></div>
        <div id="desibot-input-container">
          <input type="text" id="desibot-input" placeholder="Enter your mobile number..." maxlength="10" />
          <button id="desibot-send">âž¤</button>
        </div>
      `;

      document.body.appendChild(container);
    }

    // Show the chat container and hide the launcher
    container.style.display = "flex";
    launcher.style.display = "none";

    const closeBtn = container.querySelector("#desibot-close");
    const messagesDiv = container.querySelector("#desibot-messages");
    const input = container.querySelector("#desibot-input");
    const sendBtn = container.querySelector("#desibot-send");

    let step = 0;
    let mobile = "";
    let userName = "";

    function appendMessage(text, sender = "bot") {
      const div = document.createElement("div");
      div.className = `desibot-message desibot-${sender}`;
      div.innerHTML = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function fetchChatHistory() {
        fetch(`${backendUrl}/api/chat/history`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mobile: mobile, userId: userId })
        })
          .then(res => res.json())
          .then(data => {
            if (data && Array.isArray(data)) {
              data.forEach(message => {
                appendMessage(message.message, message.sender);
              });
      
              // ðŸ‘‹ Welcome back message after loading history
              if(data.length>0){
              setTimeout(() => {
                appendMessage(`ðŸ‘‹ Welcome back, ${userName}!`, "bot");
              }, 300); // small delay to ensure it shows after history
            }
        }
          })
          .catch(() => appendMessage("âš ï¸ Unable to fetch chat history."));
      }

    function handleInput() {
      const text = input.value.trim();
      if (!text) return;

      if (step === 0) {
        if (/^\d{10}$/.test(text)) {
          mobile = text;
          appendMessage(`Got it! Now, what's your name?`, "bot");
          input.value = "";
          input.placeholder = "Enter your name...";
          input.removeAttribute("maxlength"); 
          step = 1;
        } else {
          appendMessage("âš ï¸ Please enter a valid 10-digit mobile number.", "bot");
          input.value = "";
        }
      } else if (step === 1) {
        userName = text;
        appendMessage(`Hello ${userName}! How can I assist you today?`, "bot");
        input.placeholder = "Type a message...";
        input.value = "";
        step = 2;
  fetchChatHistory();
          
      } else if (step === 2) {
        appendMessage(text, "user");
        input.value = "";

        fetch(`${backendUrl}/api/chat/send`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mobile,
            userid: userId,
            text,
            sender: "user",
            sendername: userName
          })
        })
          .then(res => res.json())
          .then(data => appendMessage(data.message || "âœ”ï¸ Received"))
          .catch(() => appendMessage("âš ï¸ Unable to reach server."));
      }
    }

    sendBtn.onclick = handleInput;

    input.addEventListener("keypress", function (e) {
      if (step === 0 && !/^\d$/.test(e.key) && e.key !== "Backspace") e.preventDefault();
      if (e.key === "Enter") handleInput();
    });

    closeBtn.onclick = () => {
      container.style.display = "none";
      launcher.style.display = "flex"; // Show the launcher when chat is closed
    };

    // Only show greeting message on first time interaction
    if (isFirstTime) {
      appendMessage("ðŸ‘‹ Hey! I'm DesiBot. Please enter your mobile number.", "bot");
      isFirstTime = false; // Set it to false after the first greeting
    }
  };
};
